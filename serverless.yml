service:
  name: quotebot-ui

# Add the serverless-webpack plugin
plugins:
  - serverless-finch
  - serverless-webpack
  - serverless-offline

provider:
  name: aws
  runtime: nodejs6.10

functions:
  hello:
    handler: handler.handler
    events:
      - http:
          method: ANY
          path: /api/{proxy+}

resources:
  Resources:
    ProxyResource:
      Type: AWS::ApiGateway::Resource
      Properties:
        ParentId:
          Fn::GetAtt:
            - ApiGatewayRestApi
            - RootResourceId
        PathPart: app
        RestApiId:
          Ref: ApiGatewayRestApi
    ProxyMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        ResourceId:
          Ref: ProxyResource
        RestApiId:
          Ref: ApiGatewayRestApi
        HttpMethod: GET
        AuthorizationType: NONE
        MethodResponses:
          - StatusCode: 200
            ResponseParameters:
              "method.response.header.Content-Type": true
        Integration:
          IntegrationHttpMethod: GET
          Type: HTTP
          Uri: http://quotebot-ui-static-angular-app.s3-website-us-east-1.amazonaws.com
          IntegrationResponses:
            - StatusCode: 200
              ResponseParameters:
                "method.response.header.Content-Type": "'text/html'"
    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Origins:
            - DomainName: quotebot-ui-static-angular-app.s3-website-us-east-1.amazonaws.com
              Id: quotebot-static-s3-site
              CustomOriginConfig:
                HTTPPort: '80'
                HTTPSPort: '443'
                OriginProtocolPolicy: http-only
            - DomainName: bok5fjezib.execute-api.us-east-1.amazonaws.com
              OriginPath: '/dev'
              Id: quotebot-ui-api
              CustomOriginConfig: 
                HTTPPort: '80'
                HTTPSPort: '443'
                OriginProtocolPolicy: https-only
          Enabled: 'true'
          CacheBehaviors:
            - TargetOriginId: quotebot-ui-api
              PathPattern: "/api/*"
              ViewerProtocolPolicy: redirect-to-https
              MinTTL: '0'
              AllowedMethods:
                - HEAD
                - GET
              CachedMethods:
                - HEAD
                - GET
              ForwardedValues:
                QueryString: 'true'
                Cookies:
                  Forward: none
          DefaultCacheBehavior:
            TargetOriginId: quotebot-static-s3-site
            ViewerProtocolPolicy: redirect-to-https
            MinTTL: '0'
            AllowedMethods:
              - HEAD
              - GET
            ForwardedValues:
              QueryString: 'true'
              Cookies:
                Forward: none
          PriceClass: PriceClass_200
          ViewerCertificate:
            CloudFrontDefaultCertificate: 'true'
            MinimumProtocolVersion: 'TLSv1'
          DefaultRootObject: index.html

custom:
  client:
    bucketName: quotebot-ui-static-angular-app
    distributionFolder: 'dist'